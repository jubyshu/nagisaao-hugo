<section class="post-comments">
  <div id="disqus_thread"></div>
  <script src="https://{{ .Site.Params.cdn }}/npm/disqusjs@1.3/dist/disqus.js"></script>
  <script>
    window.disqusLoaded = false;

    function loadDisqus() {
      if (window.disqusLoaded) return;
      
      const dsqjs = new DisqusJS({
        shortname: "{{ .Site.Params.disqus.shortname }}",
        siteName: "{{ .Site.Params.disqus.sitename }}",
        identifier: window.location.href.substring(18),
        url: window.location.href,
        apikey: "{{ .Site.Params.disqus.apikey }}",
        admin: "{{ .Site.Params.disqus.admin }}",
        adminLabel: "{{ .Site.Params.disqus.mod }}",
        nocomment: "{{ .Site.Params.disqus.nocomment }}"
      });

      window.disqusLoaded = true;
    }

    window.addEventListener("themechange", (e) => {
      if (!window.disqusLoaded) return;

      const el = document.getElementById("disqus_thread");
      if (el) el.replaceChildren();

      window.disqusLoaded = false;
      requestAnimationFrame(() => {
        loadDisqus();
        document.getElementById("dsqjs")?.remove();
      });      
    });

    let runningOnBrowser = typeof window !== "undefined";
    let isBot = runningOnBrowser && !("onscroll" in window)
      || typeof navigator !== "undefined"
      && /(gle|ing|ro|msn)bot|crawl|spider|yand|duckgo/i.test(navigator.userAgent);
    let supportsIntersectionObserver = runningOnBrowser && "IntersectionObserver" in window;

    setTimeout(function () {
      if (!isBot && supportsIntersectionObserver) {
        let disqus_observer = new IntersectionObserver(function(entries) {
          if (entries[0].isIntersecting) {
            loadDisqus();
            disqus_observer.disconnect();
          }
        }, { threshold: [0] });
        disqus_observer.observe(document.getElementById("disqus_thread"));
      } else {
        loadDisqus();
      }
    }, 1);
  </script>
</section>
